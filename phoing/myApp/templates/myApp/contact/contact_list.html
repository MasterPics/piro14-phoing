{% extends 'myApp/layout.html' %}
{% load static %}

{% block content %}


<div>
    <!--category-->
    <div>
        <ul class="category">
            <li><a href="javascript:void(0)" onclick="onClickLink('all')">All</a></li>
            <li><a href="javascript:void(0)" onclick="onClickLink('photographer')">Photographer</a></li>
            <li><a href="javascript:void(0)" onclick="onClickLink('model')">Model</a></li>
            <li><a href="javascript:void(0)" onclick="onClickLink('HairMakeup')">Hair/Makeup</a></li>
            <li><a href="javascript:void(0)" onclick="onClickLink('stylist')">Stylist</a></li>
            <li><a href="javascript:void(0)" onclick="onClickLink('otheruse')">Other Use</a></li>
        </ul>
    </div>


    <!--sort-->
    <div>
        <select name="" id="" class="form-control sort ">
            <option value="recent" {% if sort == 'recent' %}selected{% endif %}>
                최신순
            </option>
            <option value="save" {% if sort == 'save' %}selected{% endif %}>
                저장순
            </option>
            <option value="pay" {% if sort == 'pay' %}selected{% endif %}>
                가격순
            </option>
        </select>
    </div>

    <!--search-->
    <div class="col-4 input-group">
        <input type="text" class="form-control search" value="{{ search|default_if_none:"" }}">
        <div class="input-group-append">
            <button class="btn btn-outline-secondary btn_search" type="button" id="">찾기</button>
        </div>
    </div>
</div>


<!--contact_list-->
{% for contact in contacts %}
<p>User : {{ contact.user }}</p>


<p>Pay : {{ contact.pay }}원</p>


<a href="{% url 'myApp:contact_detail' contact.pk %}">
    <p>{{ contact.title }}</p>
</a>




<!--Save-->
<div class="save save-{{contact.id}}">
    {% if request_user in contact.save_users.all %}
    <i class="fas fa-bookmark" type="submit" onclick="onClickSave({{ contact.id }})" name="type" value="save"></i>
    {% else %}
    <i class="far fa-bookmark" type="submit" onclick="onClickSave({{ contact.id }})" name="type" value="save"></i>
    {% endif %}
    <span class="save__content">{{ contact.save_users.count }}</span>
</div>
{% endfor %}
<!--contact_create-->
<div>
    <i class="far fa-comment-dots"></i>
    <span class="comment__content">{{ contact.contact_comments.count }}</span>
</div>

{% if request_user.is_authenticated %}
<p><a class="update_btn" href="{% url 'myApp:contact_create' %}">contact 만들기</a></p>
{% endif %}


<!--filter form-->
<form id="searchForm" method="get" action="{% url 'myApp:contact_list' %}">
    <!--category-->
    <input type="hidden" id="category" name="category" value="{{ category }}">
    <!--sort-->
    <input type="hidden" id="search" name="search" value="{{ search|default_if_none:'' }}">
    <!--search-->
    <input type="hidden" id="sort" name="sort" value="{{ sort }}">
</form>
{% endblock content %}


<!--js-->
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type='text/javascript'>
    //Save
    //contact id : integer, request_user_id: integer, save : "save"(string)
    const onClickSave = async (contact_id) => {
        try {
            // const url = '/contact/';
            // const {
            //     data
            // } = await axios.post(url, {
            //     contact_id,
            // })
            // modify(data.contact_id, data.is_saved)

            const options = {
                url: '/contact/',
                method: 'POST',
                data: {
                    contact_id: contact_id,
                }
            }
            const response = await axios(options)
            if (response && response.status === 200 && response.statusText === 'OK') {
                const data = response.data
                //modify에서는 이미 뒤집힌 is_saved 값이 들어감!
                modify(data.contact_id, data.is_saved)
            }
        } catch (error) {
            console.log(error)
        }
    }

    const modify = (contact_id, is_saved) => {
        const save = document.querySelector(`.save-${contact_id} i`);
        const save_content = document.querySelector(`.save-${contact_id} .save__content`)
        const num = save_content.innerText; // [ {{ contact.save_users.count }} ]
        console.log(num)
        if (is_saved === true) {

            save.className = "fas fa-bookmark";

            const count = Number(num) + 1;
            save_content.innerHTML = count
        } else {
            save.className = "far fa-bookmark";

            const count = Number(num) - 1;
            save_content.innerHTML = count
        }

    }
    //category
    const onClickLink = (category) => {
        const categoryIdInput = document.querySelector('#category')
        categoryIdInput.value = category
        const searchForm = document.querySelector('#searchForm')
        searchForm.submit()
    }

    //search
    const searchButton = document.querySelector('.btn_search')
    searchButton.addEventListener('click', () => {
        const searchClassInput = document.querySelector('.search')
        const searchIdInput = document.querySelector('#search')
        const searchForm = document.querySelector('#searchForm')
        searchIdInput.value = searchClassInput.value
        searchForm.submit()
    })


    //sort
    const sortClassInput = document.querySelector('.sort')
    sortClassInput.addEventListener('input', (e) => {
        const sortIdInput = document.querySelector('#sort')
        const searchForm = document.querySelector('#searchForm')
        sortIdInput.value = e.target.value
        searchForm.submit()
    })
</script>
{% endblock script %}